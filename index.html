<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Face Extractor</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #faces { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
    .face-box { border: 2px solid black; width: 160px; height: 200px; overflow: hidden; }
    .face-box img { width: 100%; height: 100%; object-fit: cover; }
    #previewImg { max-width: 90%; margin-top: 20px; display: none; }
  </style>
</head>

<body>

<h2>Upload Image â†’ Extract All Faces</h2>
<input type="file" id="imageUpload">

<img id="previewImg">

<div id="faces"></div>

<script>
  async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri("./");
    await faceapi.nets.faceLandmark68Net.loadFromUri("./");
    console.log("Models loaded");
  }

  loadModels();

  document.getElementById("imageUpload").addEventListener("change", async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const img = document.getElementById("previewImg");
    img.src = URL.createObjectURL(file);
    img.style.display = "block";

    img.onload = async () => {
      console.log("Image loaded on screen");

      const detections = await faceapi
          .detectAllFaces(img, new faceapi.SsdMobilenetv1Options())
          .withFaceLandmarks();

      console.log("Detected faces:", detections.length);

      const facesContainer = document.getElementById("faces");
      facesContainer.innerHTML = "";

      if (detections.length === 0) {
        facesContainer.innerHTML = "<p>No faces detected. Try another photo.</p>";
        return;
      }

      // Crop all faces
      detections.forEach((detection) => {
        const { x, y, width, height } = detection.detection.box;

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, x, y, width, height, 0, 0, width, height);

        const faceDiv = document.createElement("div");
        faceDiv.className = "face-box";

        const faceImg = new Image();
        faceImg.src = canvas.toDataURL();

        faceDiv.appendChild(faceImg);
        facesContainer.appendChild(faceDiv);
      });
    };
  });
</script>

</body>
</html>
